# Система управления ремонта вагонного оборудования

README‑гайд по установке, запуску и работе с шаблонами Word

---

## 1. О чём проект

Инструмент для учёта ремонтов железнодорожных вагонов и автоматического формирования актов, отчётов и документов‑шаблонов.
Основные компоненты:

| Модуль                  | Назначение                                                                           |
| ----------------------- | ------------------------------------------------------------------------------------ |
| **`DB.py`**             | создание/пере‑создание SQLite‑БД с нужными таблицами                                 |
| **`fill_test_data.py`** | наполнение БД реалистичными тест‑данными                                             |
| **`GUI.py`**            | полнофункциональное PyQt‑приложение для работы с БД, отчётами Excel и шаблонами Word |
| **`Editor.py`**         | «голый» визуальный редактор SQLite‑таблиц                                            |
| **`word.py`**           | движок шаблонизации Word с поддержкой маркеров и списков                             |

## 2. Быстрый старт

```bash
# 1. создаём и активируем виртуальное окружение (по желанию)
python -m venv venv
source venv/bin/activate            # Windows: venv\Scripts\activate

# 2. ставим зависимости
pip install PyQt5 python-docx pandas openpyxl

# 3. создаём базу
python DB.py                         # создаст wagons.db в текущей папке

# 4. заполняем тест‑данными
python fill_test_data.py             # 50 выполненных работ, 10 вагонов и т.д.

# 5а. запускаем основное GUI‑приложение
python GUI.py

# 5б. либо минимальный редактор без отчётов
python Editor.py
```

## 3. Работа в GUI

<details>
<summary>Шаги</summary>

1. **Открыть/создать БД**
   Кнопки «Открыть БД» и «Создать БД». После подключения активируются остальные элементы.

2. **Заполнить тестовыми данными** – перезаписывает все таблицы с данными из `fill_test_data.py`.

3. **Табличный режим**

   * Выберите таблицу (выпадающий список слева).
   * «Добавить запись» – пустая строка; «Удалить запись(и)» – выделенные строки.
   * Для таблицы **`выполненные_работы`** используется специальная форма «Добавить вып. работу» (диалог со списками договоров/услуг/вагонов).

4. **Отчёты**

   * **Акт работ (Excel)** – агрегирует выполненные работы по договору, формирует `.xlsx`.
   * **Выписка по договору (Excel)** – то же, но без ТО‑объёма.
   * **Расчёт оплаты работника** – сводка и сумма за период.
   * **Заполнить шаблон Word** – подробно в след. разделе.

</details>

## 4. Шаблонизация Word

### 4.1 Формат маркеров

| Тип                      | Пример                                                              | Подстановка                                                   |
| ------------------------ | ------------------------------------------------------------------- | ------------------------------------------------------------- |
| **Простой**              | `[вагоны.номер]`, `[договоры.дата]`                                 | значение одноимённого поля из выбранной записи                |
| **Функциональный**       | `сумма(договоры.номер)`                                             | пользовательская функция над параметром                       |
| **Маркированный список** | `список_работ(договоры.номер)` → значение `LIST:работа 1\|работа 2` | в документ будет вставлен маркированный список «• работа 1 …» |

> `word.py` устойчив к разрывам маркеров на несколько *runs* и умеет обрабатывать LIST‑значения.

### 4.2 Заполнение через GUI

1. В главном окне нажмите **«Заполнить шаблон Word»**.
2. Укажите *шаблон* (`.docx`) и *файл‑приёмник*.
3. Программа вытащит все маркеры (`extract_placeholders`) и покажет форму:

   * стандартные поля (№ акта, дата, город, …);
   * combobox’ы для договора, вагона, исполнителя;
   * строки для «прочих» маркеров.
4. Заполните форму → **OK**. Документ сохранится с подменёнными значениями.

### 4.3 Использование движка в CLI/скриптах

```python
from word import extract_placeholders, replace_placeholders

template = "doc/act_template.docx"
mapping = {
    "договоры.номер": "2024‑000123",
    "договоры.дата":  "03.05.2025",
    "вагоны.номер":   "024‑06064",
    # маркёр‑список:
    "список_работ(договоры.номер)": "LIST:Замена колесных пар|Проверка автосцепки",
}

# посмотреть, что надо заполнить
print(extract_placeholders(template))

# сделать итоговый файл
replace_placeholders(template, "output/act_filled.docx", mapping)
```

Для списка достаточно добавить префикс **`LIST:`** и разделять элементы вертикальной чертой.

## 5. Структура БД (SQLite)

```
вагоны(id, номер, собственник, подразделение, дата_ремонта)
договоры(id, номер, дата)
услуги(id, наименование, стоимость_без_ндс, стоимость_с_ндс, стоимость_работнику, описание)
договорные_услуги(id_договора, id_услуги)        # m:n
исполнители(id, фио)
выполненные_работы(id, id_вагона, id_договора, id_услуги,
                   id_исполнителя, дата_начала, дата_окончания, подписант)
```

Все внешние ключи каскадируют при `UPDATE/DELETE`.

## 6. Зависимости и требования

| Пакет           | Версия (≈) | Для чего                  |
| --------------- | ---------- | ------------------------- |
| **Python 3.9+** | –          |                           |
| **PyQt5**       | 5.15       | графический интерфейс     |
| **python‑docx** | 1.1        | чтение/запись `.docx`     |
| **pandas**      | 2.x        | сводные таблицы для Excel |
| **openpyxl**    | 3.x        | экспорт `.xlsx`           |
| **sqlite3**     | stdlib     | локальная БД              |

> При необходимости добавьте остальные пакеты в `requirements.txt`.

## 7. Советы по созданию собственных шаблонов

1. Пишите маркеры **строго** в квадратных скобках без пробелов: `[таблица.поле]`.
2. Не разбивайте маркер на две строки в Word – но скрипт всё равно найдёт его, если это произошло случайно.
3. Для списков используйте форму `LIST:элемент1|элемент2|…`.
4. Функциональные маркеры должны соответствовать регулярному выражению `function(arg)` – движок найдёт их, но обработку функции реализуйте сами в Python и передайте готовое значение в `mapping`.

## 8. Разработка и расширение

* Добавляйте свои функции‑маркеры, модифицируя `word.py::_rewrite_paragraphs` или формируя значения заранее.
* В GUI легко внедрить новые отчёты – достаточно создать диалог и использовать `pandas`+`openpyxl`.
* Для больших объёмов данных можно заменить `sqlite` на PostgreSQL; логика ORM не используется, поэтому изменения ограничатся строкой подключения.

---

### Лицензия

MIT — делайте с кодом всё, что угодно, но без гарантий.

Счастливых ремонтов!
